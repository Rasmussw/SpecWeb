import { DOCUMENT } from '@angular/common';
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "../../logging/logger.service";
import * as i2 from "../../storage/storage-persistence.service";
class PopUpService {
    get result$() {
        return this.resultInternal$.asObservable();
    }
    get windowInternal() {
        return this.document.defaultView;
    }
    constructor(document, loggerService, storagePersistenceService) {
        this.document = document;
        this.loggerService = loggerService;
        this.storagePersistenceService = storagePersistenceService;
        this.STORAGE_IDENTIFIER = 'popupauth';
        this.resultInternal$ = new Subject();
    }
    isCurrentlyInPopup(config) {
        if (this.canAccessSessionStorage()) {
            const popup = this.storagePersistenceService.read(this.STORAGE_IDENTIFIER, config);
            return (!!this.windowInternal.opener &&
                this.windowInternal.opener !== this.windowInternal &&
                !!popup);
        }
        return false;
    }
    openPopUp(url, popupOptions, config) {
        const optionsToPass = this.getOptions(popupOptions);
        this.storagePersistenceService.write(this.STORAGE_IDENTIFIER, 'true', config);
        this.popUp = this.windowInternal.open(url, '_blank', optionsToPass);
        if (!this.popUp) {
            this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER, config);
            this.loggerService.logError(config, 'Could not open popup');
            return;
        }
        this.loggerService.logDebug(config, 'Opened popup with url ' + url);
        const listener = (event) => {
            if (!event?.data || typeof event.data !== 'string') {
                this.cleanUp(listener, config);
                return;
            }
            this.loggerService.logDebug(config, 'Received message from popup with url ' + event.data);
            this.resultInternal$.next({ userClosed: false, receivedUrl: event.data });
            this.cleanUp(listener, config);
        };
        this.windowInternal.addEventListener('message', listener, false);
        this.handle = this.windowInternal.setInterval(() => {
            if (this.popUp?.closed) {
                this.resultInternal$.next({ userClosed: true });
                this.cleanUp(listener, config);
            }
        }, 200);
    }
    sendMessageToMainWindow(url) {
        if (this.windowInternal.opener) {
            const href = this.windowInternal.location.href;
            this.sendMessage(url, href);
        }
    }
    cleanUp(listener, config) {
        this.windowInternal.removeEventListener('message', listener, false);
        this.windowInternal.clearInterval(this.handle);
        if (this.popUp) {
            this.storagePersistenceService.remove(this.STORAGE_IDENTIFIER, config);
            this.popUp.close();
            this.popUp = null;
        }
    }
    sendMessage(url, href) {
        this.windowInternal.opener.postMessage(url, href);
    }
    getOptions(popupOptions) {
        const popupDefaultOptions = {
            width: 500,
            height: 500,
            left: 50,
            top: 50,
        };
        const options = {
            ...popupDefaultOptions,
            ...(popupOptions || {}),
        };
        const left = this.windowInternal.screenLeft +
            (this.windowInternal.outerWidth - options.width) / 2;
        const top = this.windowInternal.screenTop +
            (this.windowInternal.outerHeight - options.height) / 2;
        options.left = left;
        options.top = top;
        return Object.entries(options)
            .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
            .join(',');
    }
    canAccessSessionStorage() {
        return (typeof navigator !== 'undefined' &&
            navigator.cookieEnabled &&
            typeof Storage !== 'undefined');
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: PopUpService, deps: [{ token: DOCUMENT }, { token: i1.LoggerService }, { token: i2.StoragePersistenceService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: PopUpService, providedIn: 'root' }); }
}
export { PopUpService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: PopUpService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: i1.LoggerService }, { type: i2.StoragePersistenceService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItYXV0aC1vaWRjLWNsaWVudC9zcmMvbGliL2xvZ2luL3BvcHVwL3BvcHVwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7Ozs7QUFPM0MsTUFDYSxZQUFZO0lBU3ZCLElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0lBRUQsSUFBWSxjQUFjO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7SUFDbkMsQ0FBQztJQUVELFlBQ3FDLFFBQWtCLEVBQ3BDLGFBQTRCLEVBQzVCLHlCQUFvRDtRQUZsQyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ3BDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFuQnRELHVCQUFrQixHQUFHLFdBQVcsQ0FBQztRQU1qQyxvQkFBZSxHQUFHLElBQUksT0FBTyxFQUFlLENBQUM7SUFjM0QsQ0FBQztJQUVKLGtCQUFrQixDQUFDLE1BQTJCO1FBQzVDLElBQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFLEVBQUU7WUFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FDL0MsSUFBSSxDQUFDLGtCQUFrQixFQUN2QixNQUFNLENBQ1AsQ0FBQztZQUVGLE9BQU8sQ0FDTCxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNO2dCQUM1QixJQUFJLENBQUMsY0FB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QUssQ0FBQyxFQUFFLEVBQUUsQ0FDZixHQUFHLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxFQUFFLENBQzVEO2FBQ0EsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsQ0FBQztJQUVPLHVCQUF1QjtRQUM3QixPQUFPLENBQ0wsT0FBTyxTQUFTLEtBQUssV0FBVztZQUNoQyxTQUFTLENBQUMsYUFBYTtZQUN2QixPQUFPLE9BQU8sS0FBSyxXQUFXLENBQy9CLENBQUM7SUFDSixDQUFDOzhHQXRKVSxZQUFZLGtCQWtCYixRQUFRO2tIQWxCUCxZQUFZLGNBREMsTUFBTTs7U0FDbkIsWUFBWTsyRkFBWixZQUFZO2tCQUR4QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7MEJBbUI3QixNQUFNOzJCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IE9wZW5JZENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9jb25maWcvb3BlbmlkLWNvbmZpZ3VyYXRpb24nO1xyXG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zdG9yYWdlL3N0b3JhZ2UtcGVyc2lzdGVuY2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IFBvcHVwT3B0aW9ucyB9IGZyb20gJy4vcG9wdXAtb3B0aW9ucyc7XHJcbmltcG9ydCB7IFBvcHVwUmVzdWx0IH0gZnJvbSAnLi9wb3B1cC1yZXN1bHQnO1xyXG5cclxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcclxuZXhwb3J0IGNsYXNzIFBvcFVwU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBTVE9SQUdFX0lERU5USUZJRVIgPSAncG9wdXBhdXRoJztcclxuXHJcbiAgcHJpdmF0ZSBwb3BVcDogV2luZG93O1xyXG5cclxuICBwcml2YXRlIGhhbmRsZTogbnVtYmVyO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHJlc3VsdEludGVybmFsJCA9IG5ldyBTdWJqZWN0PFBvcHVwUmVzdWx0PigpO1xyXG5cclxuICBnZXQgcmVzdWx0JCgpOiBPYnNlcnZhYmxlPFBvcHVwUmVzdWx0PiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN1bHRJbnRlcm5hbCQuYXNPYnNlcnZhYmxlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCB3aW5kb3dJbnRlcm5hbCgpOiBXaW5kb3cge1xyXG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXc7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQ6IERvY3VtZW50LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlOiBTdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlXHJcbiAgKSB7fVxyXG5cclxuICBpc0N1cnJlbnRseUluUG9wdXAoY29uZmlnOiBPcGVuSWRDb25maWd1cmF0aW9uKTogYm9vbGVhbiB7XHJcbiAgICBpZiAodGhpcy5jYW5BY2Nlc3NTZXNzaW9uU3RvcmFnZSgpKSB7XHJcbiAgICAgIGNvbnN0IHBvcHVwID0gdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLnJlYWQoXHJcbiAgICAgICAgdGhpcy5TVE9SQUdFX0lERU5USUZJRVIsXHJcbiAgICAgICAgY29uZmlnXHJcbiAgICAgICk7XHJcblxyXG4gICAgICByZXR1cm4gKFxyXG4gICAgICAgICEhdGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIgJiZcclxuICAgICAgICB0aGlzLndpbmRvd0ludGVybmFsLm9wZW5lciAhPT0gdGhpcy53aW5kb3dJbnRlcm5hbCAmJlxyXG4gICAgICAgICEhcG9wdXBcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBvcGVuUG9wVXAoXHJcbiAgICB1cmw6IHN0cmluZyxcclxuICAgIHBvcHVwT3B0aW9uczogUG9wdXBPcHRpb25zLFxyXG4gICAgY29uZmlnOiBPcGVuSWRDb25maWd1cmF0aW9uXHJcbiAgKTogdm9pZCB7XHJcbiAgICBjb25zdCBvcHRpb25zVG9QYXNzID0gdGhpcy5nZXRPcHRpb25zKHBvcHVwT3B0aW9ucyk7XHJcblxyXG4gICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLndyaXRlKFxyXG4gICAgICB0aGlzLlNUT1JBR0VfSURFTlRJRklFUixcclxuICAgICAgJ3RydWUnLFxyXG4gICAgICBjb25maWdcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5wb3BVcCA9IHRoaXMud2luZG93SW50ZXJuYWwub3Blbih1cmwsICdfYmxhbmsnLCBvcHRpb25zVG9QYXNzKTtcclxuXHJcbiAgICBpZiAoIXRoaXMucG9wVXApIHtcclxuICAgICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLnJlbW92ZSh0aGlzLlNUT1JBR0VfSURFTlRJRklFUiwgY29uZmlnKTtcclxuICAgICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0Vycm9yKGNvbmZpZywgJ0NvdWxkIG5vdCBvcGVuIHBvcHVwJyk7XHJcblxyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5sb2dnZXJTZXJ2aWNlLmxvZ0RlYnVnKGNvbmZpZywgJ09wZW5lZCBwb3B1cCB3aXRoIHVybCAnICsgdXJsKTtcclxuXHJcbiAgICBjb25zdCBsaXN0ZW5lciA9IChldmVudDogTWVzc2FnZUV2ZW50KTogdm9pZCA9PiB7XHJcbiAgICAgIGlmICghZXZlbnQ/LmRhdGEgfHwgdHlwZW9mIGV2ZW50LmRhdGEgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdGhpcy5jbGVhblVwKGxpc3RlbmVyLCBjb25maWcpO1xyXG5cclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dEZWJ1ZyhcclxuICAgICAgICBjb25maWcsXHJcbiAgICAgICAgJ1JlY2VpdmVkIG1lc3NhZ2UgZnJvbSBwb3B1cCB3aXRoIHVybCAnICsgZXZlbnQuZGF0YVxyXG4gICAgICApO1xyXG5cclxuICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IGZhbHNlLCByZWNlaXZlZFVybDogZXZlbnQuZGF0YSB9KTtcclxuXHJcbiAgICAgIHRoaXMuY2xlYW5VcChsaXN0ZW5lciwgY29uZmlnKTtcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy53aW5kb3dJbnRlcm5hbC5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgbGlzdGVuZXIsIGZhbHNlKTtcclxuXHJcbiAgICB0aGlzLmhhbmRsZSA9IHRoaXMud2luZG93SW50ZXJuYWwuc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5wb3BVcD8uY2xvc2VkKSB7XHJcbiAgICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IHRydWUgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuY2xlYW5VcChsaXN0ZW5lciwgY29uZmlnKTtcclxuICAgICAgfVxyXG4gICAgfSwgMjAwKTtcclxuICB9XHJcblxyXG4gIHNlbmRNZXNzYWdlVG9NYWluV2luZG93KHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIpIHtcclxuICAgICAgY29uc3QgaHJlZiA9IHRoaXMud2luZG93SW50ZXJuYWwubG9jYXRpb24uaHJlZjtcclxuXHJcbiAgICAgIHRoaXMuc2VuZE1lc3NhZ2UodXJsLCBocmVmKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xlYW5VcChsaXN0ZW5lcjogYW55LCBjb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiB2b2lkIHtcclxuICAgIHRoaXMud2luZG93SW50ZXJuYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGxpc3RlbmVyLCBmYWxzZSk7XHJcbiAgICB0aGlzLndpbmRvd0ludGVybmFsLmNsZWFySW50ZXJ2YWwodGhpcy5oYW5kbGUpO1xyXG5cclxuICAgIGlmICh0aGlzLnBvcFVwKSB7XHJcbiAgICAgIHRoaXMuc3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZS5yZW1vdmUodGhpcy5TVE9SQUdFX0lERU5USUZJRVIsIGNvbmZpZyk7XHJcbiAgICAgIHRoaXMucG9wVXAuY2xvc2UoKTtcclxuICAgICAgdGhpcy5wb3BVcCA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNlbmRNZXNzYWdlKHVybDogc3RyaW5nLCBocmVmOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMud2luZG93SW50ZXJuYWwub3BlbmVyLnBvc3RNZXNzYWdlKHVybCwgaHJlZik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldE9wdGlvbnMocG9wdXBPcHRpb25zOiBQb3B1cE9wdGlvbnMpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcG9wdXBEZWZhdWx0T3B0aW9uczogUG9wdXBPcHRpb25zID0ge1xyXG4gICAgICB3aWR0aDogNTAwLFxyXG4gICAgICBoZWlnaHQ6IDUwMCxcclxuICAgICAgbGVmdDogNTAsXHJcbiAgICAgIHRvcDogNTAsXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9uczogUG9wdXBPcHRpb25zID0ge1xyXG4gICAgICAuLi5wb3B1cERlZmF1bHRPcHRpb25zLFxyXG4gICAgICAuLi4ocG9wdXBPcHRpb25zIHx8IHt9KSxcclxuICAgIH07XHJcbiAgICBjb25zdCBsZWZ0OiBudW1iZXIgPVxyXG4gICAgICB0aGlzLndpbmRvd0ludGVybmFsLnNjcmVlbkxlZnQgK1xyXG4gICAgICAodGhpcy53aW5kb3dJbnRlcm5hbC5vdXRlcldpZHRoIC0gb3B0aW9ucy53aWR0aCkgLyAyO1xyXG4gICAgY29uc3QgdG9wOiBudW1iZXIgPVxyXG4gICAgICB0aGlzLndpbmRvd0ludGVybmFsLnNjcmVlblRvcCArXHJcbiAgICAgICh0aGlzLndpbmRvd0ludGVybmFsLm91dGVySGVpZ2h0IC0gb3B0aW9ucy5oZWlnaHQpIC8gMjtcclxuXHJcbiAgICBvcHRpb25zLmxlZnQgPSBsZWZ0O1xyXG4gICAgb3B0aW9ucy50b3AgPSB0b3A7XHJcblxyXG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpXHJcbiAgICAgIC5tYXAoXHJcbiAgICAgICAgKFtrZXksIHZhbHVlXSkgPT5cclxuICAgICAgICAgIGAke2VuY29kZVVSSUNvbXBvbmVudChrZXkpfT0ke2VuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSl9YFxyXG4gICAgICApXHJcbiAgICAgIC5qb2luKCcsJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNhbkFjY2Vzc1Nlc3Npb25TdG9yYWdlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiZcclxuICAgICAgbmF2aWdhdG9yLmNvb2tpZUVuYWJsZWQgJiZcclxuICAgICAgdHlwZW9mIFN0b3JhZ2UgIT09ICd1bmRlZmluZWQnXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=